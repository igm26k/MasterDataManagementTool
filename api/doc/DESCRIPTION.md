# Master Data Management Tool

**Master Data Management Tool** - API для управления справочниками с возможностью 
доступа как из _frontend_, так и другими CRM системами. 

### Общая концепция
**Это универсальный инструмент для добавления/редактирования 
справочников и бизнес-процессов.**

Основная структура базы данных основана на коллекциях MongoDB.
В этом случае нет необходимости делать сложные связи между таблицами, 
а также позволяет хранить значения для каждой строки справочника 
только одним документом. 

### Структура БД:
- DictionaryMeta - список справочников с конфигурациями (столбцы, типы данных, правила валидации и пр.)
- DictionaryValue - значения всех справочников
- Service - список всех классов для использования в сервисах
- Process - бизнес-процесс, набор выбранных сервисов выполняемых в указанном порядке при заданном условии

### Создание справочника и добавление данных
При создании справочника создается документ в коллекции **DictionaryMeta** вида:
```json5
{
  "dictionaryId": 1,
  "name": "Города",
  "columns": [
    {"name": "id","type": "integer"},
    {"name": "name_rus","type": "string"},
    {"name": "name_lat","type": "string"},
    {"name": "name_rus_alt","type": "string"},
    {"name": "name_lat_alt","type": "string"},
    {"name": "country_id","type": "integer","relation":{"dictionaryId": 2,"column": "id"}},
    {"name": "is_active","type": "boolean"}
  ],
  "rules": [
    {
      "0": ["name_rus", "name_lat", "country_id"],
      "1": "required",
      "message": "{attribute} обязательное поле"
    },
    {
      "0": ["name_lat"],
      "1": "unique",
      "message": "{attribute} должен быть уникальным"
    },
    {
      "0": ["name_rus", "name_rus_alt"],
      "1": "match",
      "not": true,
      "pattern": "\/[A-Za-z]\/",
      "message": "{attribute} может содержать только русские буквы и цифры"
    },
    {
      "0": ["name_lat", "name_lat_alt"],
      "1": "match",
      "not": true,
      "pattern": "\/[А-Яа-я]\/",
      "message": "{attribute} может содержать только латинские буквы и цифры"
    },
    {
      "0": ["is_active"],
      "1": "default",
      "value": "1"
    }
  ]
}
```
Затем, при добавлении новой строки в справочник, в коллекции 
**DictionaryValue** создается документ вида:
```json5
{
  "dictionaryId": 1,
  "id": 1,
  "name_rus": "Москва",
  "name_lat": "Moscow",
  "name_rus_alt": "",
  "name_lat_alt": "",
  "country_id": 1,
  "is_active": true
}
```
Таким образом для хранения данных о справочниках, достаточно 
только две коллекции в MongoDB. 

MongoDB имеет достаточно быстрый движок полнотекстового поиска, а также
возможность индексации по выбранным полям документов коллекции.

### Добавление сервиса и бизнес-процесса
Перед добавлением сервиса в коллекцию **Service** необходимо его
запрограммировать, учитывая валидацию входящих параметров и их типов.

После этого при помощи интерфейса администрирования в коллекцию **Service**
добавляется новый документ вида:
```json5
{
  "serviceId": 1,
  "className": "app\\service\\SendEmail",
  "description": "Отправка email-сообщения"
}
```
Для создания бизнес-процесса с помощью интерфейса указываются необходимые
условия запуска и указывается действие, при котором необходимо запустить
процесс.

Например, для кнопки "Сохранить проект" необходимо отправить письмо
всем менеджерам проекта о том, что дата окончания проекта была изменена
и меньше или равна текущей дате, т.е. проект был закрыт.
В коллекции **Process** создается документ вида:
```json5
{
  "processId": 1,
  "name": "Отправка почты менеджерам при закрытии проекта",
  "trigger": [
    ["after", 2], // serviceId, при вызове которого надо выполнить процесс
  ],
  "condition": [
    {"end_date": {"$gte": "{currentDate}"}}
  ],
  "process": {
    "0": 1 // serviceId из коллекции Service
  }
}
```